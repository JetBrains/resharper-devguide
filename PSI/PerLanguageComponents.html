


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title> / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/resharper-devguide/app/css/styles.min.css">
<link  rel="stylesheet" href="/resharper-devguide/styles/styles.css"></head>
<body data-id="PSI/PerLanguageComponents">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a href="mailto:feedback@jetbrains.com">Send feedback</a></p>
                <p>&copy; 2000&ndash;2015 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
        <div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1">
            <option data-group="primary" value="default" selected>Default</option>
            <option data-group="primary" value="default_for_gnome">GNOME</option>
            <option data-group="primary" value="default_for_kde">KDE</option>
            <option data-group="primary" value="default_for_xwin">XWindow</option>
            <option data-group="primary" value="emacs">Emacs</option>
            <option data-group="primary" value="jbuilder">JBuilder</option>
            <option data-group="primary" value="visual_studio">Visual Studio</option>
            <option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option>
            <option data-group="primary" value="eclipse">Eclipse</option>
            <option data-group="secondary" value="mac_os_x_10.5_">OS X 10.5+</option>
            <option data-group="secondary" value="mac_os_x">OS X</option>
            <option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option></select>
        </div>
    
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">

                    
                    <a name="per-language-components" class="elem-anchor"></a>
<h1>Per-language Components<a href="#per-language-components" class="anchor-link"><span></span></a></h1>

<p>The PSI is designed to work with multiple languages. It supports many features, from parsing and code rewriting, to formatting and navigation. The PSI provides cross language infrastructure to support these features, but each feature requires language specific implementations, for example, the <code class="code highlight language-text">LanguageService</code> abstract base class provides the interface to create lexers and parsers for a particular file type, but the implementation of the class must be specific to each language.</p>

<p>As such, the normal <code class="code highlight language-text">[ShellComponent]</code> and <code class="code highlight language-text">[SolutionComponent]</code> components do not help here. These component attributes can be used to create multiple implementations of an interface or abstract base class, but consumers receive a list of instances, while the PSI requires a single instance for a specific language.</p>

<p>Furthermore, languages are hierarchical, allowing for more specific or perhaps fallback implementations of services. For example, XAML inherits from the XML language, so could provide its own specific code formatter, or fall back to the XML formatter.</p>

<p>The PSI needs a mechanism that will return a single implementation of an interface or base class for a given language type. It handles this with a <a href="../Platform/ComponentModel/ContainersPartsCatalogues.html"><span>custom component container</span></a>.</p>

<p>The PSI defines the <code class="code highlight language-text">[Language]</code> attribute that derives from <code class="code highlight language-text">PartAttribute</code>, in the same way that <code class="code highlight language-text">ShellComponentAttribute</code> and <code class="code highlight language-text">SolutionComponentAttribute</code> do. Since it derives directly from <code class="code highlight language-text">PartAttribute</code>, it doesn’t get included in either the shell or solution component container. Instead, the <code class="code highlight language-text">ILanguageManager</code> component maintains a custom container (strictly speaking, it does this through inheritance, so it <em>is</em> a custom container) that filters parts in the product catalogue sets by the <code class="code highlight language-text">LanguageAttribute</code>.</p>

<p>The component specifies the language it relates to by passing the type in as a parameter to the constructor:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="na">[Language(typeof(CSharpLanguage))]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CSharpCodeFormatter</span> <span class="p">:</span> <span class="n">ICodeFormatter</span>
<span class="p">{</span>
<span class="p">}</span></code></pre>

<p>The language type is used as a key for lookup, using the <code class="code highlight language-text">ILanguageManager</code> methods, where <code class="code highlight language-text">T</code> is the type of the service being retrieved, and <code class="code highlight language-text">TLanguage</code> is the type of the language. Alternatively, the language is specified as an instance of the language type, perhaps retrieved via <code class="code highlight language-text">ITreeNode.Language</code>:</p>

<pre><code class="code-block__wrapper code-block _highlighted lang_csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">ILanguageManager</span>
<span class="p">{</span>
  <span class="n">T</span> <span class="n">GetService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">TLanguage</span><span class="p">&gt;()</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
    <span class="nc">where</span> <span class="n">TLanguage</span> <span class="p">:</span> <span class="n">PsiLanguageType</span><span class="p">;</span>
  <span class="n">T</span> <span class="n">TryGetService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">TLanguage</span><span class="p">&gt;()</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
    <span class="nc">where</span> <span class="n">TLanguage</span> <span class="p">:</span> <span class="n">PsiLanguageType</span><span class="p">;</span>
  <span class="n">T</span> <span class="n">GetService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">PsiLanguageType</span> <span class="n">languageType</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
  <span class="n">T</span> <span class="n">TryGetService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">PsiLanguageType</span> <span class="n">languageType</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetServicesFromAll</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetMultipleServicesFromAll</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetServices</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">PsiLanguageType</span> <span class="n">languageType</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">HasService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">PsiLanguageType</span> <span class="n">languageType</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
  <span class="n">T</span> <span class="n">TryGetCachedService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">PsiLanguageType</span> <span class="n">languageType</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
<span class="p">}</span>

<span class="na">[SolutionComponent]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">Lifetime</span> <span class="n">lifetime</span><span class="p">,</span> <span class="n">ILanguageManager</span> <span class="n">languageManager</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">formatter</span> <span class="p">=</span> <span class="n">languageManager</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">ICodeFormatter</span><span class="p">,</span> <span class="n">CSharpLanguage</span><span class="p">&gt;();</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>The instance of <code class="code highlight language-text">ILanguageManager</code> can be retrieved via normal shell component rules, either by constructor injection, or by using <code class="code highlight language-text">Shell.Instance.GetComponent&lt;ILanguageManager&gt;()</code>.</p>

<a name="lifetime" class="elem-anchor"></a>
<h2>Lifetime<a href="#lifetime" class="anchor-link"><span></span></a></h2>

<p>The <code class="code highlight language-text">ILanguageManager</code> component is decorated with the <code class="code highlight language-text">[PsiSharedComponent]</code> attribute, which derives from <code class="code highlight language-text">ShellComponentAttribute</code>, which means that <code class="code highlight language-text">ILanguageManager</code> is a normal shell component, and has the normal lifetime of a shell component. When the <code class="code highlight language-text">ILanguageManager</code>’s <code class="code highlight language-text">Lifetime</code> terminates, all of the parts it manages are also terminated.</p>

<p>The use of the <code class="code highlight language-text">[PsiSharedComponent]</code> attribute is not significant in and of itself. Its only significance is to indicate that this component is part of the implementation of the PSI, and instances are shared across solutions. As such, it can simply inherit from <code class="code highlight language-text">[ShellComponent]</code> to get the desired behaviour.</p>



                    <div class="last-modified">
                        Last modified: 8 May 2015
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>


<script data-main="/resharper-devguide/app/js/main.build" data-baseurl="/resharper-devguide/" src="/resharper-devguide/app/js/vendor/requirejs/require.js"></script>

</body>
</html>

